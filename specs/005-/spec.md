# Feature Specification: Slack メッセージクリーンアップと通知改善

**Feature Branch**: `005-`
**Created**: 2025-10-15
**Status**: Draft
**Input**: User description: "リクエスト受領のリプライは、処理完了時のリプライに消してしまう。処理完了のリプライはそのチャンネルにも投稿するオプションを付けて投稿する"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - クリーンな会話履歴の維持 (Priority: P1)

Slack ユーザーがボットをメンションしてリクエストを送信すると、受領確認メッセージは一時的に表示されるが、処理完了時に自動的に削除される。これにより、スレッドには最終的な結果のみが残り、会話履歴がクリーンに保たれる。

**Why this priority**: ユーザーが最も重視する体験の改善。中間ステータスメッセージが残ることでスレッドが雑然とし、重要な結果が埋もれてしまう問題を解決する。

**Independent Test**: ボットにリクエストを送信し、受領確認メッセージが表示された後、処理完了時にそのメッセージが削除され、結果メッセージのみが残ることを確認することで完全にテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーが URL を含むスレッドでボットをメンションした、**When** ボットがリクエストを受領する、**Then** スレッドに受領確認メッセージが投稿される
2. **Given** 受領確認メッセージが投稿されている、**When** 処理が完了する、**Then** 受領確認メッセージが削除され、結果メッセージのみがスレッドに残る
3. **Given** 処理中にエラーが発生した、**When** エラーメッセージが投稿される、**Then** 受領確認メッセージは削除され、エラーメッセージのみが残る

---

### User Story 2 - チャンネル全体への通知 (Priority: P1)

処理完了時、結果をスレッド返信として投稿し、同時にチャンネル全体にも表示する（`reply_broadcast: true`）。これにより、スレッドを見ていないチャンネルメンバーにも結果が自動的に共有される。

**Why this priority**: チーム全体への情報共有を確実にする重要な機能。処理結果をチャンネルメンバー全員に通知することで、情報の見落としを防ぐ。

**Independent Test**: リクエストを送信し、処理完了時の結果メッセージがスレッド内だけでなく、チャンネルのメインタイムラインにも「〜さんがスレッドで返信しました」として表示されることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがボットをメンションした、**When** 処理が完了する、**Then** 結果がスレッド返信として投稿される
2. **Given** ユーザーがボットをメンションした、**When** 処理が完了する、**Then** 結果がチャンネルのメインタイムラインにも表示される（`reply_broadcast: true` により）
3. **Given** チャンネルメンバーがスレッドを開いていない、**When** 処理が完了する、**Then** チャンネルのメインタイムラインで結果通知を確認できる

---

### Edge Cases

- 受領確認メッセージの削除に失敗した場合はどうするか？ → ログに記録し、処理は継続する（ユーザー体験には影響しない）
- 処理完了前にユーザーが受領確認メッセージを手動で削除した場合は？ → 削除試行時にエラーをログに記録するが、処理は正常に継続する
- 複数のリクエストが同時に処理されている場合、それぞれの受領確認メッセージが正しく削除されるか？ → 各リクエストのメッセージタイムスタンプを個別に追跡して確実に削除する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはリクエスト受領時に一時的な確認メッセージをスレッドに投稿しなければならない
- **FR-002**: システムは受領確認メッセージのタイムスタンプを保存し、処理完了時に参照できるようにしなければならない
- **FR-003**: システムは処理完了時（成功またはエラー）に受領確認メッセージを削除しなければならない
- **FR-004**: システムは処理完了メッセージをスレッド返信として投稿しなければならない
- **FR-005**: システムは処理完了メッセージを投稿する際、常に `reply_broadcast: true` オプションを使用しなければならない
- **FR-006**: 受領確認メッセージの削除に失敗した場合でも、処理完了メッセージの投稿は正常に行われなければならない
- **FR-007**: システムは各リクエストの受領確認メッセージタイムスタンプをデータベースに保存しなければならない

### Key Entities

- **リクエスト**: 各ユーザーリクエストを表し、受領確認メッセージのタイムスタンプ（`ack_message_ts`）を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 処理完了後、スレッド内には結果メッセージのみが残り、受領確認メッセージは削除されている（100%のケース）
- **SC-002**: 処理完了メッセージは100%のケースでチャンネルのメインタイムラインにも表示される（`reply_broadcast: true` により）
- **SC-003**: 受領確認メッセージの削除失敗がユーザー体験に影響を与えない（処理完了メッセージは常に投稿される）
- **SC-004**: ユーザーがスレッドの会話履歴をレビューする際、中間ステータスメッセージに妨げられることなく結果を確認できる

## Assumptions *(optional)*

- Slack の `chat.delete` API が利用可能であり、ボットが投稿したメッセージを削除する権限（`chat:write` スコープ）を持っている
- Slack の `reply_broadcast` パラメータは標準機能として利用可能である
- 受領確認メッセージのタイムスタンプは既存のデータベーススキーマに追加可能である（`requests` テーブルに `ack_message_ts` カラムを追加）

## Dependencies *(optional)*

- 既存の Slack Bot 実装（`src/services/slack-bot.ts`）
- 既存のリクエストキュー実装（`src/services/simple-queue.ts`）
- SQLite データベース（`requests` テーブルへのスキーマ変更が必要）

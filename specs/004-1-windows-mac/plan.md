# Implementation Plan: Cross-Platform Support and Multi-Bot Handling

**Branch**: `004-1-windows-mac` | **Date**: 2025-10-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-1-windows-mac/spec.md`

## Summary

**US1 (P1)**: Windows環境対応 - 既存のMac動作確認済みコードをWindows環境でも動作するように対応し、ドキュメントを整備する

**US2 (P2)**: マルチボット対応 - 複数のSlack Bot Appからのリクエストを受け付け、それぞれのボットに正しく応答を返す機能を実装する

**Technical Approach**:
- US1: 既存コードのクロスプラットフォーム互換性を確認・修正（主にパス処理）、Windows環境でのE2Eテスト、ドキュメント整備
- US2: ボット設定管理機能の追加、リクエストへのボット識別子紐付け、ボット別応答機能の実装

## Technical Context

**Language/Version**: Node.js 20+ / TypeScript 5.x
**Primary Dependencies**:
- 既存: @slack/bolt, Playwright, SQLite (better-sqlite3), AWS SDK v3 (R2)
- 追加: なし（既存ライブラリで対応可能）

**Storage**: SQLite (requests テーブルに bot_id カラムを追加)
**Testing**:
- US1: Windows環境での手動E2Eテスト
- US2: 複数ボット設定でのintegrationテスト

**Target Platform**:
- US1: Windows 10/11 64bit + Mac (既存)
- US2: 両プラットフォーム

**Project Type**: Single project (src/)
**Performance Goals**: 既存と同等（US1）、複数ボット追加による性能劣化なし（US2）
**Constraints**:
- US1: Windowsパス長制限（260文字）に注意
- US2: シリアル処理維持（NotebookLMアカウント制約）

**Scale/Scope**:
- US1: 既存コードの修正範囲は限定的（パス処理中心）
- US2: 影響範囲: slack-bot.ts, simple-queue.ts, config.ts, database schema

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ✅ PASSED

**Principles Applied**:
- **Simplicity**: US1はドキュメント整備と最小限のコード修正、US2は既存アーキテクチャを活用
- **Backward Compatibility**: US2は既存の単一ボット運用を維持（後方互換性100%）
- **User-Centric**: Windows対応で利用可能ユーザーを拡大、マルチボット対応で運用コスト削減

**No Violations**: 既存のアーキテクチャを維持し、必要最小限の変更で要件を満たす

## Project Structure

### Documentation (this feature)

```
specs/004-1-windows-mac/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0: クロスプラットフォーム対応調査
├── data-model.md        # Phase 1: US2のDB schema変更
├── quickstart.md        # Phase 1: Windows環境セットアップ + マルチボット設定ガイド
└── tasks.md             # Phase 2: Generated by /speckit.tasks
```

### Source Code (repository root)

```
src/
├── services/
│   ├── slack-bot.ts     # MODIFIED (US2): マルチボット対応
│   └── simple-queue.ts  # MODIFIED (US2): bot_id カラム追加対応
├── lib/
│   ├── config.ts        # MODIFIED (US2): 複数ボット設定読み込み
│   └── logger.ts        # REVIEW (US1): Windows互換性確認
└── db/
    └── migrations/
        └── 002_multi_bot.sql  # NEW (US2): bot_id カラム追加

docs/
├── setup-guide.md               # MODIFIED (US1): Windows手順追加
├── windows-setup.md             # NEW (US1): Windows専用ガイド
└── multi-bot-setup.md           # NEW (US2): 複数ボット設定ガイド

tests/
└── integration/
    └── multi-bot.test.ts  # NEW (US2): マルチボットテスト
```

**Structure Decision**: 既存のsingle project構造を維持。US1は主にドキュメント追加、US2は既存ファイルへの機能追加が中心。

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**N/A**: 憲章違反なし、既存アーキテクチャを活用した最小限の変更

---

## Phase 0: Research & Decisions

### Research Status

**Status**: ✅ 完了（既存実装の分析により明確）

### Design Decisions

#### Decision 1: Windows対応アプローチ（US1）

**Decision**: 既存コードのクロスプラットフォーム互換性を確認し、必要最小限の修正を行う

**現状分析**:
- Node.js `path` モジュールは既にクロスプラットフォーム対応
- Playwright/SQLite/AWS SDKはすべてWindows対応済み
- 主な確認ポイント: ハードコードされたパス区切り文字、OS固有のコマンド

**Alternatives Considered**:
1. Windows専用ブランチを作成 → ✗ メンテナンスコストが高い
2. Docker/WSL2経由で実行 → ✗ セットアップが複雑になる
3. **既存コードのクロスプラットフォーム対応確認** → ✓ 採用（最小限の変更）

**Rationale**:
- Node.jsは元々クロスプラットフォーム設計
- 依存ライブラリもすべてWindows対応済み
- ドキュメント整備が主な作業になる見込み

#### Decision 2: マルチボット実装アプローチ（US2）

**Decision**: 環境変数で複数ボット設定を管理し、リクエストにbot_idを紐付ける

**Architecture**:
```
環境変数:
SLACK_BOT_TOKENS=token1,token2,token3
SLACK_APP_TOKENS=appToken1,appToken2,appToken3

Bot ID生成: Bot Token のハッシュ値またはインデックス

DB Schema追加:
ALTER TABLE requests ADD COLUMN bot_id TEXT;

Slack Bot初期化:
各トークンペアに対してApp インスタンスを作成
```

**Alternatives Considered**:
1. 設定ファイル（JSON/YAML）で管理 → △ 12-factor app原則からは外れる
2. **環境変数で管理** → ✓ 採用（シンプル、セキュア）
3. データベースで動的管理 → ✗ オーバーエンジニアリング

**Rationale**:
- 環境変数は12-factor appのベストプラクティス
- デプロイ時の設定変更が容易
- シークレット管理ツールとの統合が簡単

#### Decision 3: Bot識別方法（US2）

**Decision**: Bot Tokenのハッシュ値を bot_id として使用

**Implementation**:
```typescript
function getBotId(botToken: string): string {
  return crypto.createHash('sha256')
    .update(botToken)
    .digest('hex')
    .substring(0, 16); // 16文字に短縮
}
```

**Alternatives Considered**:
1. Bot Tokenそのものを保存 → ✗ セキュリティリスク
2. **Bot Tokenのハッシュ値** → ✓ 採用（セキュアで一意）
3. インデックス番号（0, 1, 2...） → △ トークン順序変更でID変更

**Rationale**:
- セキュア（トークンが漏洩しない）
- 一意性が保証される
- トークン順序に依存しない

---

## Phase 1: Design & Contracts

### Data Model (US2のみ)

**Status**: ✅ 完了

#### 変更: requests テーブル

```sql
-- 既存のrequestsテーブルに以下を追加
ALTER TABLE requests ADD COLUMN bot_id TEXT NOT NULL DEFAULT 'default';
CREATE INDEX IF NOT EXISTS idx_requests_bot_id ON requests(bot_id);
```

**Rationale**:
- bot_id: どのボットからのリクエストかを識別
- デフォルト値'default': 既存データとの後方互換性
- インデックス: bot_id でのクエリを高速化

### API Contracts

**Status**: ✅ NOT APPLICABLE

**Rationale**:
- 外部APIの変更なし
- 内部的なボット管理機能の追加のみ
- Slack APIとのインターフェースは既存のものを使用

### Quickstart Guide

**Status**: ✅ 作成予定

#### Windows Setup Guide (US1)

以下の内容を含むドキュメントを作成:
1. Windows環境の前提条件
2. Node.js / npm のインストール
3. Playwright Chromiumのインストール
4. 環境変数の設定（PowerShellとCommand Prompt両方）
5. ボットの起動方法
6. トラブルシューティング（パス長制限、ファイアウォール、権限エラー）

#### Multi-Bot Setup Guide (US2)

以下の内容を含むドキュメントを作成:
1. 複数ボットの環境変数設定方法
2. 各ボットのSlack App設定
3. 動作確認方法
4. トラブルシューティング（トークン設定ミス、応答先ミス）

---

## Phase 2: Implementation Tasks

**Status**: ⏳ PENDING（`/speckit.tasks`コマンドで生成）

### Expected Task Breakdown

**US1: Windows Environment Support (P1)**
1. コード互換性確認（パス処理、OS固有コマンド）
2. Windows環境でのE2Eテスト
3. Windows Setup Guideドキュメント作成
4. トラブルシューティングガイド作成

**US2: Multi-Bot Handling (P2)**
1. DB migration: bot_id カラム追加
2. config.ts: 複数ボット設定読み込み機能
3. slack-bot.ts: 複数Appインスタンス管理
4. simple-queue.ts: bot_id 保存・取得機能
5. マルチボットintegrationテスト
6. Multi-Bot Setup Guideドキュメント作成

**Estimated Effort**:
- US1: 1-2日
- US2: 2-3日
- 合計: 3-5日

---

## Implementation Notes

### Key Implementation Points

#### US1: Windows Environment Support

**確認ポイント**:
1. **パス処理**: `path.join()`, `path.resolve()` を使用（✓ 既に使用中と想定）
2. **ファイル操作**: `fs` モジュールはクロスプラットフォーム対応（✓ 問題なし）
3. **環境変数**: `process.env` はクロスプラットフォーム対応（✓ 問題なし）
4. **Playwright**: Windows対応済み（✓ 公式サポート）

**Windows固有の注意点**:
- パス長制限: 260文字（`\\?\` prefix で回避可能）
- 実行権限: 管理者権限が必要な場合がある
- ファイアウォール: Node.jsの通信許可が必要

#### US2: Multi-Bot Handling

**実装戦略**:

```typescript
// config.ts
export interface BotConfig {
  botToken: string;
  appToken: string;
  botId: string;
}

export function loadBotConfigs(): BotConfig[] {
  const botTokens = (process.env.SLACK_BOT_TOKENS || '').split(',');
  const appTokens = (process.env.SLACK_APP_TOKENS || '').split(',');

  return botTokens.map((botToken, index) => ({
    botToken: botToken.trim(),
    appToken: appTokens[index]?.trim() || '',
    botId: getBotId(botToken),
  }));
}

// slack-bot.ts
export class SlackBotManager {
  private bots: Map<string, { app: App, botId: string }> = new Map();

  constructor() {
    const configs = loadBotConfigs();
    configs.forEach(config => {
      const app = new App({
        token: config.botToken,
        appToken: config.appToken,
        socketMode: true,
      });
      this.bots.set(config.botId, { app, botId: config.botId });
      this.setupEventHandlers(app, config.botId);
    });
  }

  private setupEventHandlers(app: App, botId: string) {
    app.event('app_mention', async ({ event, client }) => {
      // bot_id をリクエストに保存
      const jobId = this.queue.addJob(url, channel, threadTs, userId, botId);
      // ...
    });
  }

  async postToBot(botId: string, channel: string, threadTs: string, message: string) {
    const bot = this.bots.get(botId);
    if (!bot) {
      throw new Error(`Bot not found: ${botId}`);
    }
    await bot.app.client.chat.postMessage({
      channel,
      thread_ts: threadTs,
      text: message,
    });
  }
}
```

### Rollback Plan

**US1**:
- Windows環境で問題が発生した場合、Mac環境は影響を受けない
- ドキュメント変更のみロールバック可能

**US2**:
- 環境変数を単一ボット設定に戻すだけで既存動作に復帰
- DB migration はデフォルト値により既存データに影響なし

---

## Success Validation

### Acceptance Criteria (from spec.md)

#### US1: Windows Environment Support

実装後、以下を確認：

1. ✅ **FR-001**: Windows 10以降で正常起動
2. ✅ **FR-002**: パス区切り文字の正しい処理
3. ✅ **FR-003**: Playwright/NotebookLM自動操作の正常実行
4. ✅ **FR-004**: SQLiteデータベースの正常動作
5. ✅ **FR-005**: R2アップロードの正常実行
6. ✅ **FR-006**: Mac環境と同一機能提供
7. ✅ **FR-007**: Windowsドキュメント完備

#### US2: Multi-Bot Handling

実装後、以下を確認：

1. ✅ **FR-008**: 複数ボットからのリクエスト受付
2. ✅ **FR-009**: bot_id の保存と管理
3. ✅ **FR-010**: 正しいボットへの応答送信
4. ✅ **FR-011**: 正しいボットへのエラー通知
5. ✅ **FR-012**: 環境変数での複数ボット設定管理
6. ✅ **FR-013**: ボット間の独立性

### Success Metrics (from spec.md)

**US1**:
- SC-001: 起動成功率 95%以上
- SC-002: 処理時間 Mac比±10%以内
- SC-003: 全機能 100%動作
- SC-004: セットアップ時間 30分以内

**US2**:
- SC-005: 応答正確性 100%
- SC-006: 2ボット同時処理 30分以内
- SC-007: 識別ミス 0件
- SC-008: 後方互換性 100%

---

**Plan Status**: ✅ COMPLETE
**Next Step**: `/speckit.tasks` to generate implementation tasks

# Implementation Plan: Suppress URL Thumbnail in Queue Acknowledgment

**Branch**: `003-url` | **Date**: 2025-10-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-url/spec.md`

## Summary

処理キュー追加の確認メッセージからURLを削除し、サムネイル展開を防ぐ。現在のメッセージ：`✅ URLを受け付けました: ${url}\n\n🔄 処理キューに追加しました (Job ID: ${jobId})\n処理が完了したらこのスレッドに結果を投稿します。`をURLを含まない形式に変更する。

**Technical Approach**: 既存の確認メッセージフォーマット文字列を変更し、URLパラメータを削除する。実装は1ファイル1行の変更で完了。

## Technical Context

**Language/Version**: Node.js 20+ / TypeScript 5.x
**Primary Dependencies**: @slack/bolt (Slack Bot SDK)
**Storage**: N/A（メッセージフォーマットのみの変更）
**Testing**: 既存のSlack integration test（手動確認）
**Target Platform**: Node.js server environment
**Project Type**: Single project (src/)
**Performance Goals**: N/A（文字列処理のみ）
**Constraints**: Slack API のメッセージフォーマット仕様に準拠
**Scale/Scope**: 影響範囲：1ファイル（src/services/slack-bot.ts）、1メソッド、1行の変更

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ✅ PASSED（プロジェクト憲章未定義のため、標準的な開発プラクティスに準拠）

**General Principles Applied**:
- **Simplicity**: 最小限の変更（1行）で要件を満たす
- **Backward Compatibility**: 既存機能に影響なし（処理完了メッセージは変更しない）
- **User-Centric**: ユーザー体験の向上（視覚的ノイズ削減）

**No Violations**: この変更は既存のコードベースを拡張せず、メッセージフォーマットのみを調整する

## Project Structure

### Documentation (this feature)

```
specs/003-url/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0: Not needed (no unknowns)
├── data-model.md        # Phase 1: Not applicable (no data model changes)
├── quickstart.md        # Phase 1: Not needed (trivial change)
├── contracts/           # Phase 1: Not applicable (no API contracts)
└── tasks.md             # Phase 2: Generated by /speckit.tasks
```

### Source Code (repository root)

```
src/
├── services/
│   └── slack-bot.ts     # MODIFIED: Acknowledgment message format
└── lib/
    └── logger.ts        # UNCHANGED: Used for logging

tests/
└── integration/
    └── slack-bot.test.ts # OPTIONAL: Manual integration test
```

**Structure Decision**: Single project structure. 変更範囲が極めて限定的（1ファイル1メソッド）なため、既存の`src/services/`ディレクトリ内での修正のみ。

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**N/A**: 憲章違反なし、複雑性の増加なし

---

## Phase 0: Research & Decisions

### Research Status

**Status**: ✅ SKIPPED（研究不要）

**Rationale**:
- Slackメッセージフォーマットは既知の仕様
- URLを含めなければサムネイル展開されないことは確認済み
- 既存コードベースで同様のパターンが使用されている（処理完了メッセージなど）
- 技術的不確実性なし

### Design Decisions

#### Decision 1: メッセージフォーマット

**Decision**: URLを完全に削除し、Job IDと処理状態のみを表示

**Current Format**:
```
✅ URLを受け付けました: https://example.com/article

🔄 処理キューに追加しました (Job ID: 123)
処理が完了したらこのスレッドに結果を投稿します。
```

**New Format**:
```
✅ リクエストを受け付けました

🔄 処理キューに追加しました (Job ID: 123)
処理が完了したらこのスレッドに結果を投稿します。
```

**Alternatives Considered**:
1. URLを`<URL>`形式でラップする → ✗ 依然としてURLが表示され、メッセージが冗長
2. URLの最初の30文字のみ表示 → ✗ 部分的なURLでもサムネイル展開される可能性
3. "URLを受け付けました"のみ表示 → ✗ Job IDがないとトラッキングが困難

**Rationale**:
- URLは既にユーザーが入力済みなので再表示不要
- Job IDがあれば処理追跡が可能
- コンパクトで視覚的にクリーン

---

## Phase 1: Design & Contracts

### Data Model

**Status**: ✅ NOT APPLICABLE

**Rationale**: メッセージフォーマットの変更のみで、データモデルの変更なし

### API Contracts

**Status**: ✅ NOT APPLICABLE

**Rationale**:
- 外部APIの変更なし
- Slack APIへのメッセージ送信フォーマットのみの変更
- 既存のSlack Bolt SDKメソッドを使用

### Quickstart Guide

**Status**: ✅ NOT APPLICABLE

**Rationale**:
- ユーザー向けの使用方法は変更なし
- 内部的なメッセージフォーマット変更のみ
- README.mdの更新も不要（ユーザー体験は同じ）

---

## Phase 2: Implementation Tasks

**Status**: ⏳ PENDING（`/speckit.tasks`コマンドで生成）

### Expected Task Breakdown

1. **T001**: [src/services/slack-bot.ts:102](../../src/services/slack-bot.ts#L102) - 確認メッセージフォーマットを変更
2. **T002**: 手動統合テスト - Slackでの表示確認
3. **T003**: ドキュメント更新（該当する場合）

**Estimated Effort**: 5-10分

---

## Implementation Notes

### Key Implementation Points

1. **変更箇所**: [src/services/slack-bot.ts:102](../../src/services/slack-bot.ts#L102)

   **Before**:
   ```typescript
   `✅ URLを受け付けました: ${url}\n\n🔄 処理キューに追加しました (Job ID: ${jobId})\n処理が完了したらこのスレッドに結果を投稿します。`
   ```

   **After**:
   ```typescript
   `✅ リクエストを受け付けました\n\n🔄 処理キューに追加しました (Job ID: ${jobId})\n処理が完了したらこのスレッドに結果を投稿します。`
   ```

2. **変更しない箇所**:
   - エラーメッセージ（URLを含まないため既に問題なし）
   - 処理完了メッセージ（フォーマット済みリンクが有用なため維持）
   - URL抽出ロジック（変更不要）

3. **テスト方法**:
   - ボットを起動し、Slackでテスト
   - URLを含めてメンション
   - 確認メッセージにサムネイルが展開されないことを確認
   - Job IDが正しく表示されることを確認

### Rollback Plan

変更が1行のため、ロールバックは即座に可能：
- Git revert または手動で元のフォーマット文字列に戻す
- 再デプロイ

---

## Success Validation

### Acceptance Criteria (from spec.md)

実装後、以下を確認：

1. ✅ **FR-001**: 確認メッセージにURLが含まれていない
2. ✅ **FR-002**: Job IDと処理状態が表示される
3. ✅ **FR-003**: メッセージがコンパクトで読みやすい
4. ✅ **FR-004**: Slackでサムネイル展開が発生しない
5. ✅ **FR-005**: 処理完了メッセージは変更されていない

### Success Metrics (from spec.md)

- **SC-001**: サムネイル展開 0件 ← Slackでの手動確認
- **SC-002**: メッセージ文字数が約50%削減 ← 文字列長比較
- **SC-003**: 視覚的にスッキリしている ← ユーザー確認
- **SC-004**: 視覚的スペース消費削減 ← Slackでの手動確認

---

**Plan Status**: ✅ COMPLETE
**Next Step**: `/speckit.tasks` to generate implementation tasks

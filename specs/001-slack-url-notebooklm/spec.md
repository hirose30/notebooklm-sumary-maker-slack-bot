# 機能仕様: Slack NotebookLM Pro 統合ボット

**機能ブランチ**: `001-slack-url-notebooklm`
**作成日**: 2025-10-09
**ステータス**: ドラフト
**入力**: ユーザー説明: "Slack スレッドでのメンションをトリガーに、投稿URLを NotebookLM Pro の新規ノートへ登録し、Audio/Video Overviews を生成。生成完了後に共有可能なURL（またはファイル）を 元スレッドへ自動返信 する。個人アカウントの NotebookLM Pro を活用し、現時点で公式APIがない機能（Video Overviews 等）も UI自動操作 で実現する。"

## Clarifications

### Session 2025-10-09

- Q: Which cloud storage service should be used for storing the generated media files? → A: Cloudflare R2
- Q: When multiple URLs exist in a thread, which URL should be processed? → A: Process the first URL found in the thread
- Q: What technology should be used for automating NotebookLM Pro's UI? → A: Playwright or Chrome DevTools MCP
- Q: What format should users use to mention the bot and trigger processing? → A: @botname only (process any URL in thread)
- Q: How should the bot respond when an error occurs during processing? → A: Simple error message only
- Q: How should the initial Google authentication for NotebookLM be handled? → A: Manual login required after each deployment/restart
- Q: NotebookLM自動化（ノートブック作成、Audio/Video生成）が技術的な理由で失敗した場合、システムはどう対応すべきですか？ → A: リトライを数回試みて、それでも失敗したら簡易エラーメッセージを返す
- Q: 同時リクエストの処理方式（SC-004で100並列 vs plan.mdでシリアル処理）はどちらを採用しますか？ → A: 段階的実装（初期はシリアル、将来並列化）- 現状はシリアルでSC-004を将来目標として明記
- Q: NotebookLMで生成されたAudio/Videoを取得する際、どの方法を使用しますか？ → A: ダウンロードURLを取得してメディアファイルをダウンロード、R2にアップロード（ファイル転送）
- Q: Playwright自動化のヘッドレスモードは本番環境でどう動作させますか？ → A: 環境変数で切り替え可能 - 開発時はヘッドフル、本番環境の可否は実装時に検証
- Q: ユーザーが自分のリクエストがキューの何番目にいるか知りたい場合、システムはどう対応しますか？ → A: キュー情報は提供しない - シンプルな「処理中」メッセージのみ

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - 音声・ビデオ概要の自動生成（優先度: P1）

SlackユーザーがURLを含むスレッドでボットをメンションすると、自動生成された音声とビデオの両方の概要がクラウドストレージにアップロードされ、そのリンクが同じスレッドに返信として投稿される。

**この優先度の理由**: これは核となる価値提案を実現する - Slackの会話で共有されたURLから手動介入なしに自動でマルチメディアコンテンツ要約を提供。

**独立テスト**: 単一のURLでボットをメンションし、音声とビデオ両方の概要へのリンクがスレッドに返されることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** Slackスレッドに記事へのURLが含まれている、**実行** ユーザーがそのスレッドでボットをメンションする、**期待結果** ボットがリクエストを確認し処理を開始する
2. **前提条件** ボットが有効なURLでメンションされた、**実行** 処理が正常に完了する、**期待結果** 音声とビデオの両方の概要がクラウドストレージに保存され、そのリンクが15分以内に同じスレッドに投稿される
3. **前提条件** ボットがスレッドにURLなしでメンションされた、**実行** ボットがメンションを処理する、**期待結果** URLが必要であることを説明する有用なエラーメッセージで返信する

---

### ユーザーストーリー 2 - 進捗状況の更新（優先度: P2）

ユーザーはリクエストの処理進捗についてリアルタイムの状況更新を受け取る。

**この優先度の理由**: 長時間実行される操作について透明性を提供することでユーザー体験を向上させるが、コア機能には影響しない。

**独立テスト**: 処理中のスレッド更新を監視し、期待される間隔で状況メッセージが表示されることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提条件** ボットが処理を開始した、**実行** 30秒以上経過した、**期待結果** 処理中であることを示す状況更新が投稿される
2. **前提条件** 処理で遅延が発生した、**実行** 予想完了時間を超過した、**期待結果** ボットが改訂された推定時間で更新を投稿する

---

### 将来対応機能

#### 複数URL処理

*注: この機能は初期リリースには含まれず、将来のアップデートで検討される*

Slackユーザーは単一のスレッドで複数のURLを送信でき、ボットはすべてのソースを単一の概要に統合したノートブックを作成する機能。この機能により、ユーザーが複数のソースから関連コンテンツの包括的な要約を得ることができ、研究や情報統合のためのボットの有用性が向上する。

---

### エッジケース

- 提供されたURLが無効またはアクセス不可の場合はどうなるか？
- NotebookLM Proが使用制限に達した場合、システムはどう処理するか？
- 処理中にボットがSlackとの接続を失った場合はどうなるか？
- システムは主言語以外の言語のコンテンツへのURLをどう処理するか？
- クラウドストレージサービスが利用不可またはクォータを超えた場合はどうなるか？
- システムは複数ユーザーからの同時リクエストをどう処理するか？→ 初期実装ではキューに追加してシリアル処理、将来的に並列処理対応を検討
- NotebookLM自動化が一時的なネットワークエラーやUIタイムアウトで失敗した場合、自動リトライ後も失敗し続ける場合はエラーメッセージを返す

## 要件

### 機能要件

- **FR-001**: システムはSlackスレッドでの「@botname」形式のボットメンションを検出し、スレッド内のURLを抽出しなければならない（追加コマンドは不要）
- **FR-002**: システムは各リクエストごとに新しいNotebookLM Proノートブックを作成しなければならない
- **FR-003**: システムは抽出されたURLをNotebookLMノートブックにソースとして追加しなければならない
- **FR-004**: システムはノートブックコンテンツから音声概要を生成しなければならない
- **FR-005**: システムはNotebookLM Proで利用可能な場合、ビデオ概要生成をサポートしなければならない
- **FR-006**: システムは元のSlackスレッドに生成された概要で返信しなければならない
- **FR-007**: システムは生成された音声とビデオの概要をNotebookLMからダウンロードし、Cloudflare R2にアップロードし、共有可能なリンクをSlackスレッドに投稿しなければならない
- **FR-008**: システムは個人のNotebookLM Proアカウントでの認証を処理しなければならない（各デプロイ/再起動後に手動ログインが必要）
- **FR-009**: システムはAPI経由で利用できない機能のために、PlaywrightまたはChrome DevTools MCPを使用してUI操作を自動化しなければならない（ヘッドレス/ヘッドフルモードは環境変数で制御可能）
- **FR-018**: NotebookLM自動化の一時的な失敗に対して、システムは自動リトライ機構を実装しなければならない（リトライ回数制限あり）
- **FR-019**: システムは初期実装として単一のNotebookLMアカウントでリクエストをシリアル処理（キューベース、1つずつ順次実行）しなければならない
- **FR-010**: システムは最大15分以内にリクエストを処理しなければならない
- **FR-011**: システムはスレッドから最初に見つかったURLを抽出し処理しなければならない（複数URLが存在する場合、最初のURLのみ処理、複数URL対応は将来実装）
- **FR-012**: システムはリクエストを処理できない場合、シンプルなエラーメッセージのみを提供しなければならない（修正提案や再試行オプションなし）
- **FR-021**: システムはキューの位置情報をユーザーに提供せず、シンプルな「処理中」ステータスのみを表示しなければならない
- **FR-013**: システムは返信が正しい場所に送られるようスレッドコンテキストを維持しなければならない
- **FR-014**: 生成された概要は作成後7日間アクセス可能でなければならない
- **FR-015**: システムはすべてのリクエストに対して音声とビデオの両方の概要を生成しなければならない
- **FR-016**: システムは生成されたメディアファイルを安全にCloudflare R2に保存し、アクセス可能なURLを生成しなければならない
- **FR-017**: クラウドストレージのURLは認証なしでアクセス可能で、指定期間（7日間）有効でなければならない
- **FR-020**: システムはNotebookLMが提供するダウンロードURLからメディアファイル（Audio/Video）を取得し、R2へ転送しなければならない

### 主要エンティティ

- **Slackメッセージ**: ボットメンションとスレッドコンテキストを含むSlackのメッセージを表す、メッセージID、スレッドID、ユーザーID、メッセージコンテンツを含む
- **URLソース**: Slackスレッドから抽出されたURLを表す、NotebookLM処理のために検証され準備される
- **NotebookLMノートブック**: ソースと生成された概要を含むNotebookLM Proのノートブックインスタンスを表す
- **概要メディア**: 生成された音声またはビデオ要約を表す、メディアタイプ、クラウドストレージURL、有効期限、メタデータを含む
- **処理リクエスト**: メンションから完了までのユーザーリクエストのライフサイクルを追跡、ステータス、タイムスタンプ、エラー情報を含む

## 成功基準

### 測定可能な成果

- **SC-001**: ユーザーは単一URLリクエストの95%に対して、ボットをメンションしてから15分以内に生成された概要応答を受け取る
- **SC-002**: システムは有効なURL送信の90%に対して概要の処理と生成に成功する
- **SC-003**: ユーザーの80%が最初のボット操作で生成された概要を正常に受信しアクセスできる
- **SC-004**: システムは初期実装ではシリアル処理（1リクエストずつ順次処理）を行い、将来的にはパフォーマンスの低下なしに少なくとも100の同時処理リクエストを処理できるよう拡張可能である
- **SC-005**: 生成された音声概要は典型的な記事コンテンツに対して2〜10分の長さである
- **SC-006**: ボットはメンションから10秒以内に初期確認で応答する
- **SC-007**: エラーメッセージは失敗ケースの70%でユーザーが独立して問題を解決するのに役立つ
- **SC-008**: システムは正しいSlackスレッドへの返信投稿で99%の精度を維持する

## 前提条件

- NotebookLM Proアカウントが予想されるリクエスト量に対して十分な使用枠を持っている
- UI自動化アプローチがNotebookLM Proインターフェースの更新に対して安定している
- Playwright自動化がヘッドレスモードで動作可能である、または本番環境でヘッドフルモード実行が可能である（Xvfb等の仮想ディスプレイ使用を含む）
- デプロイまたは再起動後に管理者がNotebookLMに手動でログインできる環境
- Slackワークスペースがボット統合を許可している
- ユーザーが提供するURLが認証なしで公開アクセス可能である
- 処理時間の期待値がNotebookLM Proの生成遅延を考慮している
- 生成されたコンテンツが適用される著作権とフェアユースのガイドラインに準拠している
- 単一のNotebookLM Proアカウントが予想される同時使用パターンを処理できる
- Cloudflare R2が利用可能で、生成されたメディアファイルの保存に十分な容量を持っている
- Cloudflare R2が公開共有リンクの生成と有効期限管理をサポートしている